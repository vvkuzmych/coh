# User Roles System

## Overview

The application uses an **enum-based role system** to differentiate users by their access level.

## Role Hierarchy

| Role         | Value | Description                                  | Access Level |
|--------------|-------|----------------------------------------------|--------------|
| `guest`      | 0     | Signed-in user with limited access           | Lowest       |
| `member`     | 1     | Regular user with standard features          | Standard     |
| `admin`      | 2     | Administrator with elevated privileges       | High         |
| `super_admin`| 3     | Super administrator with full system access  | Highest      |

## Database Schema

### Migration

```ruby
class AddRoleToUsers < ActiveRecord::Migration[8.1]
  def change
    add_column :users, :role, :integer, default: 0, null: false
    add_index :users, :role
  end
end
```

- **Default role**: `guest` (0)
- **Not null**: Every user must have a role
- **Indexed**: For fast role-based queries

## Model Implementation

### User Model

```ruby
class User < ApplicationRecord
  # ... associations ...
  
  enum :role, {
    guest: 0,
    member: 1,
    admin: 2,
    super_admin: 3
  }, prefix: true
  
  # Role-based scopes
  scope :administrators, -> { where(role: [:admin, :super_admin]) }
  scope :regular_users, -> { where(role: [:guest, :member]) }
  
  # Role helper methods
  def administrator?
    admin? || super_admin?
  end
  
  def regular_user?
    guest? || member?
  end
end
```

## Usage Examples

### Creating Users with Roles

```ruby
# Create a guest user (default)
guest = User.create!(
  email: "guest@example.com",
  first_name: "Guest",
  last_name: "User",
  account: account
)
guest.role_guest?   # => true
guest.role          # => "guest"

# Create a member
member = User.create!(
  email: "member@example.com",
  first_name: "John",
  last_name: "Doe",
  account: account,
  role: :member
)
member.role_member? # => true

# Create an admin
admin = User.create!(
  email: "admin@example.com",
  first_name: "Admin",
  last_name: "User",
  account: account,
  role: :admin
)
admin.role_admin?   # => true

# Create a super admin
super_admin = User.create!(
  email: "superadmin@example.com",
  first_name: "Super",
  last_name: "Admin",
  account: account,
  role: :super_admin
)
super_admin.role_super_admin? # => true
```

### Updating User Roles

```ruby
user = User.find_by(email: "member@example.com")

# Method 1: Using enum methods
user.role_admin!
# => Updates role to admin and saves

# Method 2: Direct assignment
user.role = :super_admin
user.save!

# Method 3: Update attributes
user.update!(role: :member)
```

### Checking User Roles

```ruby
user = User.find(1)

# Enum-generated methods (auto-generated by Rails)
user.role_guest?       # => true/false
user.role_member?      # => true/false
user.role_admin?       # => true/false
user.role_super_admin? # => true/false

# Custom helper methods
user.administrator?    # => true if admin or super_admin
user.regular_user?     # => true if guest or member

# Get role as string
user.role              # => "guest", "member", "admin", or "super_admin"
```

### Querying by Role

```ruby
# Find all users with a specific role
User.role_guest
User.role_member
User.role_admin
User.role_super_admin

# Using where clause
User.where(role: :admin)
User.where(role: [:admin, :super_admin])

# Using custom scopes
User.administrators    # => All admins and super_admins
User.regular_users     # => All guests and members

# Count users by role
User.role_admin.count
User.administrators.count

# Get all roles
User.roles
# => {"guest"=>0, "member"=>1, "admin"=>2, "super_admin"=>3}
```

### Role-Based Authorization Example

```ruby
# In a controller
class DocumentsController < ApplicationController
  before_action :require_member, only: [:create, :update]
  before_action :require_admin, only: [:destroy]
  
  private
  
  def require_member
    unless current_user.role_member? || current_user.administrator?
      redirect_to root_path, alert: "Access denied"
    end
  end
  
  def require_admin
    unless current_user.administrator?
      redirect_to root_path, alert: "Admin access required"
    end
  end
end
```

### Role Comparison

```ruby
# Compare roles by value
user1 = User.role_member.first
user2 = User.role_admin.first

User.roles[user1.role]  # => 1
User.roles[user2.role]  # => 2

# Check if user has higher or equal role
def has_role_or_higher?(user, required_role)
  User.roles[user.role] >= User.roles[required_role.to_s]
end

has_role_or_higher?(user2, :member) # => true (admin >= member)
has_role_or_higher?(user1, :admin)  # => false (member < admin)
```

## Account-Level Role Distribution

```ruby
# Get role distribution for an account
account = Account.find(1)

account.users.group(:role).count
# => {"guest"=>5, "member"=>20, "admin"=>3, "super_admin"=>1}

# Get all admins in an account
account.users.administrators

# Promote a user within an account
user = account.users.find_by(email: "john@example.com")
user.role_admin!
```

## Seeds Example

```ruby
# db/seeds.rb
account = Account.create!(name: "Demo Corporation")

# Create super admin
super_admin = account.users.create!(
  email: "superadmin@demo.com",
  first_name: "Super",
  last_name: "Admin",
  role: :super_admin
)

# Create admin
admin = account.users.create!(
  email: "admin@demo.com",
  first_name: "Admin",
  last_name: "User",
  role: :admin
)

# Create members
5.times do |i|
  account.users.create!(
    email: "member#{i}@demo.com",
    first_name: "Member",
    last_name: "#{i}",
    role: :member
  )
end

# Create guests
3.times do |i|
  account.users.create!(
    email: "guest#{i}@demo.com",
    first_name: "Guest",
    last_name: "#{i}",
    role: :guest
  )
end
```

## Role Descriptions

### Guest (`guest`)
- **Default role** for new users
- Limited access to features
- Can view basic content
- Cannot create or modify documents
- Use case: Trial users, newly signed-up users

### Member (`member`)
- **Standard user role**
- Full access to personal features
- Can create, edit, delete own documents
- Cannot access admin features
- Use case: Regular active users

### Admin (`admin`)
- **Administrative role**
- Can manage users within account
- Can view/edit all documents in account
- Can access admin dashboard
- Cannot modify super_admin users
- Use case: Team leaders, managers

### Super Admin (`super_admin`)
- **Highest privilege level**
- Full system access
- Can manage all users including admins
- Can modify account settings
- Can access system-wide features
- Use case: Account owners, system administrators

## Authorization Patterns

### Policy-Based (Pundit Example)

```ruby
# app/policies/document_policy.rb
class DocumentPolicy < ApplicationPolicy
  def create?
    user.role_member? || user.administrator?
  end
  
  def update?
    user.administrator? || record.user_id == user.id
  end
  
  def destroy?
    user.administrator?
  end
end
```

### Role-Based Abilities (CanCanCan Example)

```ruby
# app/models/ability.rb
class Ability
  include CanCan::Ability
  
  def initialize(user)
    user ||= User.new # guest user (not logged in)
    
    if user.role_super_admin?
      can :manage, :all
    elsif user.role_admin?
      can :manage, User, account_id: user.account_id
      can :manage, Document
    elsif user.role_member?
      can :read, Document
      can :manage, Document, user_id: user.id
    elsif user.role_guest?
      can :read, Document
    end
  end
end
```

## Testing Examples

```ruby
# spec/models/user_spec.rb
RSpec.describe User, type: :model do
  describe 'roles' do
    it 'defaults to guest role' do
      user = User.new
      expect(user.role_guest?).to be true
    end
    
    it 'can be assigned different roles' do
      user = User.create!(
        email: "test@example.com",
        first_name: "Test",
        last_name: "User",
        account: account,
        role: :admin
      )
      
      expect(user.role_admin?).to be true
      expect(user.administrator?).to be true
    end
    
    it 'can update roles' do
      user = create(:user, role: :guest)
      user.role_member!
      
      expect(user.role_member?).to be true
      expect(user.role_guest?).to be false
    end
  end
  
  describe 'scopes' do
    before do
      create(:user, role: :guest)
      create(:user, role: :member)
      create(:user, role: :admin)
      create(:user, role: :super_admin)
    end
    
    it 'returns administrators' do
      expect(User.administrators.count).to eq(2) # admin + super_admin
    end
    
    it 'returns regular users' do
      expect(User.regular_users.count).to eq(2) # guest + member
    end
  end
end
```

## Migration & Rollback

### Run the migration
```bash
rails db:migrate
```

### Rollback if needed
```bash
rails db:rollback
```

### Check schema
```bash
rails db:schema:dump
cat db/schema.rb | grep -A 5 "create_table \"users\""
```

## Best Practices

1. **Use symbols for role assignment**: `user.role = :admin` (not `"admin"` or `2`)
2. **Use enum methods for checking**: `user.role_admin?` (not `user.role == "admin"`)
3. **Use scopes for queries**: `User.role_admin` (not `User.where(role: 2)`)
4. **Set default role**: Always have a sensible default (guest)
5. **Index the role column**: For performance on role-based queries
6. **Use helper methods**: Create `administrator?` type methods for grouped checks
7. **Document role permissions**: Keep this file updated with role capabilities

## Security Considerations

- **Never trust user input for role assignment**: Validate role changes server-side
- **Log role changes**: Keep audit trail of role modifications
- **Protect super_admin creation**: Only allow through seeds or console
- **Use strong_parameters**: Whitelist role in controllers carefully

```ruby
# In controller
def user_params
  if current_user.role_super_admin?
    params.require(:user).permit(:email, :first_name, :last_name, :role)
  else
    params.require(:user).permit(:email, :first_name, :last_name)
  end
end
```

## Console Commands

```bash
# Open Rails console
rails console

# Count users by role
User.group(:role).count

# List all admins
User.administrators.pluck(:email, :role)

# Promote a user
user = User.find_by(email: "john@example.com")
user.role_admin!

# Demote a user
user.role_member!
```
